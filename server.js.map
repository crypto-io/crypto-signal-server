{"version":3,"file":"server.js","sources":["src/index.js"],"sourcesContent":["import {createWatcher} from 'ip-monitor';\r\nimport { Server } from 'http';\r\nimport express from 'express';\r\nimport _io from 'socket.io';\r\nimport ecdh from 'crypto-ecdh';\r\nimport swarmKey from 'js-ipfs-swarm-key-gen';\r\nimport { read } from 'crypto-io-fs';\r\nimport { join } from 'path';\r\nimport { homedir } from 'os';\r\nimport { info } from 'crypto-logger';\r\n\r\nconst app = express();\r\nconst server = Server(app);\r\nconst io = _io(server);\r\nconst store = {};\r\nconst bootstrap = new Map();\r\nconst connections = new Map();\r\n\r\nswarmKey().then(() => info('key Initialized: ready for connections'));\r\n/**\r\n * Main peernet address\r\n * @param {string} ip The ip for the running daemon\r\n * @return {string} The address as a MultiAddress /ip4/ip/protocol/port/ipfs/peerID\r\n */\r\nconst address = ip => `/ip4/${ip}/tcp/80/ipfs/QmPgX72kLV9Gopq77tMFAQfMZWBGp6Va3AFcmJyeQawTCm`;\r\n\r\n/**\r\n * @important\r\n * hardcoded privateKey, the key is used for network identification so that only our nodes are on it...\r\n * this key IS NOT used for any security services!\r\n */\r\n\r\nclass SecureConnection {\r\n  constructor(socket, pair) {\r\n    // declare properties\r\n    this.id = socket.id;\r\n    this.pair = pair;\r\n    this.socket = socket;\r\n    // bind methods\r\n    this.handshake = this.handshake.bind(this);\r\n    // init listeners & emitters\r\n    this.shake();\r\n  }\r\n  /**\r\n   * Initialize double handshake\r\n   *\r\n   * Info: Even when a public key is leaked the attacker doesn't get the time to even think about bruteforcing\r\n   */\r\n  shake() {\r\n    this.socket.on('_handshake', this.handshake);\r\n    this.socket.emit('handshake', this.pair.public);\r\n    this.socket.on('request-key', this.keyRequest);\r\n  }\r\n\r\n  handshake(key) {\r\n    (async () => {\r\n      try {\r\n        this.pair.derive(key);\r\n        // prepare the new keys\r\n        const pair = ecdh('hex');\r\n        const cipher = await this.pair.encrypt(pair.public);\r\n        this.socket.on('_secure-connection', async cipher => {\r\n          try {\r\n            const key = await this.pair.decrypt(cipher);\r\n            this.pair = pair;\r\n            this.pair.derive(key);\r\n            const encrypted = await this.pair.encrypt(address(store.ip));\r\n            this.socket.emit('network', encrypted.toString());\r\n            this.socket.on('address', data => console.log(data));\r\n          } catch (e) {\r\n            console.error(e);\r\n          } finally {\r\n\r\n          }\r\n        })\r\n        // send our encrypted key to the client\r\n        this.socket.emit('secure-connection', cipher.toString());\r\n      } catch (e) {\r\n        console.error(e);\r\n      }\r\n    })()\r\n  }\r\n  async keyRequest() {\r\n    const key = await read(join(homedir(), '.ipfs', 'swarm.key'), 'string');\r\n    const cipher = await this.pair.encrypt(key);\r\n    this.socket.emit('_request-key', cipher.toString())\r\n  }\r\n}\r\n\r\nio.on('connection', socket => {\r\n  socket.join('network');\r\n  connections.set(socket.id, {status: 'pending'});\r\n  new SecureConnection(socket, ecdh('hex'));\r\n});\r\n\r\nio.on('disconnect', socket => {\r\n  const address = connections.get(socket.id);\r\n  connections.remove(socket.id);\r\n  bootstrap.remove(address);\r\n});\r\n\r\n// TODO: check if needed when a peer is connected already...\r\nconst announceAddress = ip => {\r\n  store.ip = ip;\r\n  io.to('network', {address: address(ip)});\r\n}\r\n\r\nconst watcher = createWatcher();\r\n\r\nwatcher.on('IP:change', (oldIP, newIP) => {\r\n  if (oldIP !== newIP) announceAddress(newIP);\r\n});\r\n\r\nwatcher.start();\r\n\r\nserver.listen(9090, () => info('listening on 9090'));\r\n"],"names":["app","express","server","Server","io","_io","store","bootstrap","Map","connections","swarmKey","then","info","address","ip","SecureConnection","socket","pair","id","handshake","bind","shake","on","emit","public","keyRequest","key","derive","ecdh","cipher","encrypt","decrypt","encrypted","toString","data","console","log","e","error","read","join","homedir","set","status","get","remove","announceAddress","to","watcher","createWatcher","oldIP","newIP","start","listen"],"mappings":";;;;;;;;;;;;;;;AAWA,MAAMA,MAAMC,SAAZ;AACA,MAAMC,SAASC,YAAOH,GAAP,CAAf;AACA,MAAMI,KAAKC,IAAIH,MAAJ,CAAX;AACA,MAAMI,QAAQ,EAAd;AACA,MAAMC,YAAY,IAAIC,GAAJ,EAAlB;AACA,MAAMC,cAAc,IAAID,GAAJ,EAApB;AAEAE,WAAWC,IAAX,CAAgB,MAAMC,kBAAK,wCAAL,CAAtB;AAMA,MAAMC,UAAUC,MAAO,QAAOA,EAAG,6DAAjC;AAQA,MAAMC,gBAAN,CAAuB;cACTC,MAAZ,EAAoBC,IAApB,EAA0B;SAEnBC,EAAL,GAAUF,OAAOE,EAAjB;SACKD,IAAL,GAAYA,IAAZ;SACKD,MAAL,GAAcA,MAAd;SAEKG,SAAL,GAAiB,KAAKA,SAAL,CAAeC,IAAf,CAAoB,IAApB,CAAjB;SAEKC,KAAL;;UAOM;SACDL,MAAL,CAAYM,EAAZ,CAAe,YAAf,EAA6B,KAAKH,SAAlC;SACKH,MAAL,CAAYO,IAAZ,CAAiB,WAAjB,EAA8B,KAAKN,IAAL,CAAUO,MAAxC;SACKR,MAAL,CAAYM,EAAZ,CAAe,aAAf,EAA8B,KAAKG,UAAnC;;YAGQC,GAAV,EAAe;KACZ,YAAY;UACP;aACGT,IAAL,CAAUU,MAAV,CAAiBD,GAAjB;cAEMT,OAAOW,KAAK,KAAL,CAAb;cACMC,SAAS,MAAM,KAAKZ,IAAL,CAAUa,OAAV,CAAkBb,KAAKO,MAAvB,CAArB;aACKR,MAAL,CAAYM,EAAZ,CAAe,oBAAf,EAAqC,MAAMO,MAAN,IAAgB;cAC/C;kBACIH,MAAM,MAAM,KAAKT,IAAL,CAAUc,OAAV,CAAkBF,MAAlB,CAAlB;iBACKZ,IAAL,GAAYA,IAAZ;iBACKA,IAAL,CAAUU,MAAV,CAAiBD,GAAjB;kBACMM,YAAY,MAAM,KAAKf,IAAL,CAAUa,OAAV,CAAkBjB,QAAQP,MAAMQ,EAAd,CAAlB,CAAxB;iBACKE,MAAL,CAAYO,IAAZ,CAAiB,SAAjB,EAA4BS,UAAUC,QAAV,EAA5B;iBACKjB,MAAL,CAAYM,EAAZ,CAAe,SAAf,EAA0BY,QAAQC,QAAQC,GAAR,CAAYF,IAAZ,CAAlC;WANF,CAOE,OAAOG,CAAP,EAAU;oBACFC,KAAR,CAAcD,CAAd;WARF,SASU;SAVZ;aAeKrB,MAAL,CAAYO,IAAZ,CAAiB,mBAAjB,EAAsCM,OAAOI,QAAP,EAAtC;OApBF,CAqBE,OAAOI,CAAP,EAAU;gBACFC,KAAR,CAAcD,CAAd;;KAvBJ;;QA2BIZ,UAAN,GAAmB;UACXC,MAAM,MAAMa,gBAAKC,UAAKC,YAAL,EAAgB,OAAhB,EAAyB,WAAzB,CAAL,EAA4C,QAA5C,CAAlB;UACMZ,SAAS,MAAM,KAAKZ,IAAL,CAAUa,OAAV,CAAkBJ,GAAlB,CAArB;SACKV,MAAL,CAAYO,IAAZ,CAAiB,cAAjB,EAAiCM,OAAOI,QAAP,EAAjC;;;AAIJ7B,GAAGkB,EAAH,CAAM,YAAN,EAAoBN,UAAU;SACrBwB,IAAP,CAAY,SAAZ;cACYE,GAAZ,CAAgB1B,OAAOE,EAAvB,EAA2B,EAACyB,QAAQ,SAAT,EAA3B;MACI5B,gBAAJ,CAAqBC,MAArB,EAA6BY,KAAK,KAAL,CAA7B;CAHF;AAMAxB,GAAGkB,EAAH,CAAM,YAAN,EAAoBN,UAAU;QACtBH,UAAUJ,YAAYmC,GAAZ,CAAgB5B,OAAOE,EAAvB,CAAhB;cACY2B,MAAZ,CAAmB7B,OAAOE,EAA1B;YACU2B,MAAV,CAAiBhC,OAAjB;CAHF;AAOA,MAAMiC,kBAAkBhC,MAAM;QACtBA,EAAN,GAAWA,EAAX;KACGiC,EAAH,CAAM,SAAN,EAAiB,EAAClC,SAASA,QAAQC,EAAR,CAAV,EAAjB;CAFF;AAKA,MAAMkC,UAAUC,yBAAhB;AAEAD,QAAQ1B,EAAR,CAAW,WAAX,EAAwB,CAAC4B,KAAD,EAAQC,KAAR,KAAkB;MACpCD,UAAUC,KAAd,EAAqBL,gBAAgBK,KAAhB;CADvB;AAIAH,QAAQI,KAAR;AAEAlD,OAAOmD,MAAP,CAAc,IAAd,EAAoB,MAAMzC,kBAAK,mBAAL,CAA1B"}